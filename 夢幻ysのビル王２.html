<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ“ãƒ«ç‹</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            /* è¦æ±‚ä»•æ§˜ï¼šèƒŒæ™¯é€é */
            background-color: transparent;
            overflow: hidden; /* ç´™å¹é›ªã®ãŸã‚ */
        }

        /* ã‚¹ãƒãƒ›ã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ï¼ˆãƒãƒƒãƒãªã©ï¼‰ã‚’è€ƒæ…® */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ã®ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (7x7) */
        #board {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(7, 1fr);
            gap: 2px; /* ç‹­ãã™ã‚‹ */
            width: 100%;
            aspect-ratio: 1 / 1;
            position: relative; /* é§’ã®é…ç½®åŸºæº– */
        }

        /* å„ãƒã‚¹ */
        .cell {
            border: 1px solid #6b7280; /* gray-500 */
            border-radius: 4px; /* rounded */
            padding: 2px; /* p-0.5 */
            background-color: rgba(255, 255, 255, 0.8); /* ç™½ã®åŠé€æ˜ */
            display: flex;
            flex-direction: column;
            /* â˜…å¤‰æ›´ï¼šä¸Šæƒãˆã«ã—ã¦ã€å¢—ç¯‰ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã¨ã®è¡çªã‚’é¿ã‘ã‚‹ */
            justify-content: flex-start;
            align-items: center;
            font-size: 0.65rem; /* text-xsã‚ˆã‚Šå°ã•ã */
            line-height: 0.8rem;
            position: relative; /* ã‚ªãƒ¼ãƒŠãƒ¼è¡¨ç¤ºãƒ»ãƒ“ãƒ«è¡¨ç¤ºã®åŸºæº– */
            overflow: hidden;
            text-align: center;
        }
        
        /* ãƒã‚¹ã®ã‚ªãƒ¼ãƒŠãƒ¼è¡¨ç¤º */
        .owner-badge {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px; /* ç´°ãã™ã‚‹ */
        }

        /* â˜…å¤‰æ›´ï¼šå¢—ç¯‰ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« (ç©ã¿ä¸Šã’å¼) */
        .building-level {
            position: absolute;
            bottom: 1px;
            left: 0;
            right: 0;
            margin: auto;
            display: flex;
            flex-direction: column-reverse; /* ä¸‹ã‹ã‚‰ç©ã¿ä¸Šã’ */
            align-items: center;
        }
        .building-level span {
            /* â˜…å¤‰æ›´ï¼šã•ã‚‰ã«å°ã•ãã—ã¦é‡ãªã‚Šã‚’å›é¿ */
            width: 8px; /* å››è§’ã«å¤‰æ›´ */
            height: 3px; /* å››è§’ã«å¤‰æ›´ */
            background-color: #d1d5db; /* gray-300 */
            border: 1px solid #6b7280;
            margin-top: 1px; /* ç©ã¿ä¸Šã’æ™‚ã®éš™é–“ */
        }
        /* ç‰©ä»¶ã‚¿ã‚¤ãƒ—ã”ã¨ã®è‰²åˆ†ã‘ */
        .building-level span.built-building { background-color: #3b82f6; } /* ãƒ“ãƒ« (é’) */
        .building-level span.built-commercial { background-color: #f59e0b; } /* å•†æ¥­æ–½è¨­ (é»„) */
        .building-level span.built-shopping { background-color: #22c55e; } /* å•†åº—è¡— (ç·‘) */


        /* â˜…å¤‰æ›´ï¼šãƒœãƒ¼ãƒ‰ä¸­å¤® (UIé›†ä¸­ã‚¨ãƒªã‚¢) */
        .center-area {
            grid-column: 2 / span 5;
            grid-row: 2 / span 5;
            display: flex;
            flex-direction: column;
            justify-content: space-around; /* ä¸­èº«ã‚’å‡ç­‰é…ç½® */
            padding: 4px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            overflow: hidden; /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚°ã®ãŸã‚ */
        }
        
        /* â˜…è¿½åŠ ï¼šä¸­å¤®UIå†…ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .center-status-item {
            border-radius: 6px;
            padding: 2px 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .center-status-item .money {
            font-size: 0.9rem; /* 1.125rem -> 0.9rem */
            font-weight: 700;
        }
        .center-status-item .name {
            font-size: 0.7rem;
            font-weight: 700;
        }

        /* â˜…è¿½åŠ ï¼šã‚µã‚¤ã‚³ãƒ­è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #dice-animation-area {
            height: 60px; /* 60px */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #dice-display {
            font-size: 3.75rem; /* 6xl */
            color: #374151; /* gray-700 */
        }


        /* ç‰¹å®šã®ãƒã‚¹ã®é…ç½® (7x7 = 24ãƒã‚¹) */
        #cell-0 { grid-column: 1; grid-row: 1; } /* ã‚¹ã‚¿ãƒ¼ãƒˆ */
        #cell-1 { grid-column: 2; grid-row: 1; }
        #cell-2 { grid-column: 3; grid-row: 1; }
        #cell-3 { grid-column: 4; grid-row: 1; }
        #cell-4 { grid-column: 5; grid-row: 1; }
        #cell-5 { grid-column: 6; grid-row: 1; }
        #cell-6 { grid-column: 7; grid-row: 1; } /* ã‚¤ãƒ™ãƒ³ãƒˆ */
        #cell-7 { grid-column: 7; grid-row: 2; }
        #cell-8 { grid-column: 7; grid-row: 3; }
        #cell-9 { grid-column: 7; grid-row: 4; }
        #cell-10 { grid-column: 7; grid-row: 5; }
        #cell-11 { grid-column: 7; grid-row: 6; }
        #cell-12 { grid-column: 7; grid-row: 7; } /* ã‚¤ãƒ™ãƒ³ãƒˆ */
        #cell-13 { grid-column: 6; grid-row: 7; }
        #cell-14 { grid-column: 5; grid-row: 7; }
        #cell-15 { grid-column: 4; grid-row: 7; }
        #cell-16 { grid-column: 3; grid-row: 7; }
        #cell-17 { grid-column: 2; grid-row: 7; }
        #cell-18 { grid-column: 1; grid-row: 7; } /* ã‚¤ãƒ™ãƒ³ãƒˆ */
        #cell-19 { grid-column: 1; grid-row: 6; }
        #cell-20 { grid-column: 1; grid-row: 5; }
        #cell-21 { grid-column: 1; grid-row: 4; }
        #cell-22 { grid-column: 1; grid-row: 3; }
        #cell-23 { grid-column: 1; grid-row: 2; }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é§’ */
        .piece {
            position: absolute;
            width: 16px; /* 7x7ç”¨ã«å°ã•ã */
            height: 16px; /* 7x7ç”¨ã«å°ã•ã */
            border-radius: 9999px; /* rounded-full */
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.5s ease-in-out;
            z-index: 10;
        }
        
        /* é§’ã®ä½ç½®èª¿æ•´ (7x7ç”¨) */
        #player-piece { background-color: #3b82f6; /* blue-500 */ transform: translate(10%, 10%); }
        #cpu1-piece { background-color: #ef4444; /* red-500 */ transform: translate(60%, 10%); }
        #cpu2-piece { background-color: #22c55e; /* green-500 */ transform: translate(10%, 60%); }
        
        /* â˜…å¤‰æ›´ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚° (ä¸­å¤®UIå†…) */
        #message-log {
            height: 60px; /* 100px -> 60px */
            overflow-y: auto; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
            background-color: rgba(243, 244, 246, 0.8); /* gray-100ã®åŠé€æ˜ */
            border: 1px solid #d1d5db; /* gray-300 */
            font-size: 0.75rem; /* text-xs */
            padding: 2px;
            border-radius: 6px;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒ€ã‚¤ã‚¢ãƒ­ã‚°) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 24px; /* p-6 */
            border-radius: 12px; /* rounded-xl */
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
        }

        /* ç ´ç”£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
        .bankrupt {
            filter: grayscale(100%);
            opacity: 0.5;
        }

        /* å‹åˆ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ (ç´™å¹é›ª) */
        #confetti-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯é€é */
            overflow: hidden;
            z-index: 100;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0.7;
            animation: confetti-fall 3s linear infinite;
        }
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotateZ(0deg);
                opacity: 0.7;
            }
            100% {
                transform: translateY(100vh) rotateZ(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-transparent text-gray-800">

    <!-- ç´™å¹é›ªãƒ©ãƒƒãƒ‘ãƒ¼ -->
    <div id="confetti-wrapper"></div>

    <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
    <div id="title-screen" class="flex flex-col items-center justify-center min-h-screen p-4">
        <h1 class="text-6xl font-bold text-center text-blue-600 drop-shadow-lg">ãƒ“ãƒ«ç‹</h1>
        <p class="text-xl text-gray-700 mt-2">Billionaire King</p>
        <div class="mt-12 space-y-4 w-full max-w-xs">
            <button id="start-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
            </button>
            <button id="load-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                ã¤ã¥ãã‹ã‚‰
            </button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <!-- â˜…å¤‰æ›´ï¼šstatus-area ã¨ control-area ã¯ board ã® center-area ã«ç§»å‹• -->
    <div id="game-screen" class="hidden min-h-screen max-w-md mx-auto flex flex-col p-2 space-y-2">
        
        <!-- 2. ãƒœãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ (UIã‚’ä¸­å¤®ã«é›†ç´„) -->
        <div class="flex-grow flex items-center justify-center">
            <div id="board">
                <!-- ãƒã‚¹ (7x7 = 24ãƒã‚¹) -->
                <div class="cell" id="cell-0"><span>ã‚¹ã‚¿ãƒ¼ãƒˆ</span><span>+Â¥20k</span></div>
                <div class="cell" id="cell-1"></div>
                <div class="cell" id="cell-2"></div>
                <div class="cell" id="cell-3"></div>
                <div class="cell" id="cell-4"></div>
                <div class="cell" id="cell-5"></div>
                <div class="cell" id="cell-6"><span>ã‚¤ãƒ™ãƒ³ãƒˆ</span><span>?</span></div>
                <div class="cell" id="cell-7"></div>
                <div class="cell" id="cell-8"></div>
                <div class="cell" id="cell-9"></div>
                <div class="cell" id="cell-10"></div>
                <div class="cell" id="cell-11"></div>
                <div class="cell" id="cell-12"><span>ã‚¤ãƒ™ãƒ³ãƒˆ</span><span>?</span></div>
                <div class="cell" id="cell-13"></div>
                <div class="cell" id="cell-14"></div>
                <div class="cell" id="cell-15"></div>
                <div class="cell" id="cell-16"></div>
                <div class="cell" id="cell-17"></div>
                <div class="cell" id="cell-18"><span>ã‚¤ãƒ™ãƒ³ãƒˆ</span><span>?</span></div>
                <div class="cell" id="cell-19"></div>
                <div class="cell" id="cell-20"></div>
                <div class="cell" id="cell-21"></div>
                <div class="cell" id="cell-22"></div>
                <div class="cell" id="cell-23"></div>
                
                <!-- â˜…å¤‰æ›´ï¼šä¸­å¤®UIã‚¨ãƒªã‚¢ -->
                <div class="center-area">
                    <!-- 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¨ãƒªã‚¢ -->
                    <div id="status-area" class="grid grid-cols-3 gap-1 text-center">
                        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
                        <div id="status-player" class="center-status-item bg-blue-100 border-2 border-blue-400">
                            <div class="name">ã‚ãªãŸ</div>
                            <div id="money-player" class="money">Â¥100,000</div>
                        </div>
                        <!-- CPU 1 -->
                        <div id="status-cpu1" class="center-status-item bg-red-100 border-2 border-red-400">
                            <div class="name">CPU 1</div>
                            <div id="money-cpu1" class="money">Â¥100,000</div>
                        </div>
                        <!-- CPU 2 -->
                        <div id="status-cpu2" class="center-status-item bg-green-100 border-2 border-green-400">
                            <div class="name">CPU 2</div>
                            <div id="money-cpu2" class="money">Â¥100,000</div>
                        </div>
                    </div>

                    <!-- â˜…è¿½åŠ ï¼šã‚µã‚¤ã‚³ãƒ­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ -->
                    <div id="dice-animation-area">
                        <div id="dice-display">ğŸ²</div>
                    </div>

                    <!-- 3. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ -->
                    <div id="control-area" class="space-y-1">
                        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚° -->
                        <div id="message-log" class="w-full">
                            <p>ãƒ“ãƒ«ç‹ã¸ã‚ˆã†ã“ãï¼</p>
                        </div>
                        <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
                        <div class="grid grid-cols-2 gap-2">
                            <button id="roll-dice-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg shadow-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                                ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹
                            </button>
                            <button id="save-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg shadow-md transition duration-200 text-sm">
                                ã‚»ãƒ¼ãƒ–
                            </button>
                        </div>
                    </div>
                </div>

                <!-- é§’ -->
                <div id="player-piece" class="piece"></div>
                <div id="cpu1-piece" class="piece"></div>
                <div id="cpu2-piece" class="piece"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒ€ã‚¤ã‚¢ãƒ­ã‚°) -->
    <div id="modal-dialog" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-4">ã‚¿ã‚¤ãƒˆãƒ«</h3>
            <p id="modal-message" class="mb-6">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡</p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                <!-- JavaScriptã§ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«è¿½åŠ  -->
            </div>
        </div>
    </div>


    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. DOMè¦ç´ ã®å–å¾— ---
            const titleScreen = document.getElementById('title-screen');
            const gameScreen = document.getElementById('game-screen');
            const startBtn = document.getElementById('start-btn');
            const loadBtn = document.getElementById('load-btn');
            const saveBtn = document.getElementById('save-btn');
            const rollDiceBtn = document.getElementById('roll-dice-btn');
            const messageLog = document.getElementById('message-log');
            
            const modal = document.getElementById('modal-dialog');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalActions = document.getElementById('modal-actions');
            
            const pieceElements = {
                player: document.getElementById('player-piece'),
                cpu1: document.getElementById('cpu1-piece'),
                cpu2: document.getElementById('cpu2-piece')
            };

            const moneyElements = {
                player: document.getElementById('money-player'),
                cpu1: document.getElementById('money-cpu1'),
                cpu2: document.getElementById('money-cpu2')
            };

            const statusElements = {
                player: document.getElementById('status-player'),
                cpu1: document.getElementById('status-cpu1'),
                cpu2: document.getElementById('status-cpu2')
            };
            
            const confettiWrapper = document.getElementById('confetti-wrapper');
            const diceDisplay = document.getElementById('dice-display'); // â˜…è¿½åŠ 

            // --- 2. ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å®šç¾© ---
            
            // ãƒœãƒ¼ãƒ‰å®šç¾© (24ãƒã‚¹, å±±æ‰‹ç·šé§…å, æ–°ç‰©ä»¶ã‚¿ã‚¤ãƒ—)
            const BOARD_DEFINITION = [
                { id: 0, name: "ã‚¹ã‚¿ãƒ¼ãƒˆ", type: "start" },
                // ä½ãƒ©ãƒ³ã‚¯ (ãƒ“ãƒ«)
                { id: 1, name: "æœ‰æ¥½ç”º", type: "property", propertyType: "building", price: 10000, rent: [2000, 5000, 12000], buildCost: [5000, 10000] },
                { id: 2, name: "æ–°æ©‹", type: "property", propertyType: "building", price: 10000, rent: [2000, 5000, 12000], buildCost: [5000, 10000] },
                { id: 3, name: "æµœæ¾ç”º", type: "property", propertyType: "building", price: 12000, rent: [2200, 5500, 13000], buildCost: [6000, 11000] },
                { id: 4, name: "ç”°ç”º", type: "property", propertyType: "building", price: 12000, rent: [2200, 5500, 13000], buildCost: [6000, 11000] },
                { id: 5, name: "é«˜è¼ª", type: "property", propertyType: "building", price: 15000, rent: [2500, 6000, 15000], buildCost: [7000, 12000] },
                { id: 6, name: "ã‚¤ãƒ™ãƒ³ãƒˆ", type: "event" },
                // ä¸­ãƒ©ãƒ³ã‚¯ (å•†åº—è¡—)
                { id: 7, name: "å“å·", type: "property", propertyType: "shopping", price: 20000, rent: [4000, 10000, 25000], buildCost: [10000, 20000] },
                { id: 8, name: "å¤§å´", type: "property", propertyType: "shopping", price: 20000, rent: [4000, 10000, 25000], buildCost: [10000, 20000] },
                { id: 9, name: "äº”åç”°", type: "property", propertyType: "shopping", price: 22000, rent: [4500, 11000, 28000], buildCost: [11000, 22000] },
                { id: 10, name: "ç›®é»’", type: "property", propertyType: "shopping", price: 22000, rent: [4500, 11000, 28000], buildCost: [11000, 22000] },
                { id: 11, name: "æµæ¯”å¯¿", type: "property", propertyType: "shopping", price: 25000, rent: [5000, 13000, 30000], buildCost: [12000, 25000] },
                { id: 12, name: "ã‚¤ãƒ™ãƒ³ãƒˆ", type: "event" },
                // é«˜ãƒ©ãƒ³ã‚¯ (å•†æ¥­æ–½è¨­)
                { id: 13, name: "æ¸‹è°·", type: "property", propertyType: "commercial", price: 35000, rent: [7000, 20000, 45000], buildCost: [20000, 35000] },
                { id: 14, name: "åŸå®¿", type: "property", propertyType: "commercial", price: 35000, rent: [7000, 20000, 45000], buildCost: [20000, 35000] },
                { id: 15, name: "æ–°å®¿", type: "property", propertyType: "commercial", price: 40000, rent: [8000, 22000, 50000], buildCost: [25000, 40000] },
                { id: 16, name: "æ± è¢‹", type: "property", propertyType: "commercial", price: 40000, rent: [8000, 22000, 50000], buildCost: [25000, 40000] },
                { id: 17, name: "å¤§å¡š", type: "property", propertyType: "commercial", price: 38000, rent: [7500, 21000, 48000], buildCost: [22000, 38000] },
                { id: 18, name: "ã‚¤ãƒ™ãƒ³ãƒˆ", type: "event" },
                // ä¸­ãƒ©ãƒ³ã‚¯ (å•†åº—è¡—)
                { id: 19, name: "å·£é´¨", type: "property", propertyType: "shopping", price: 28000, rent: [5500, 14000, 32000], buildCost: [14000, 28000] },
                { id: 20, name: "é§’è¾¼", type: "property", propertyType: "shopping", price: 28000, rent: [5500, 14000, 32000], buildCost: [14000, 28000] },
                { id: 21, name: "ç”°ç«¯", type: "property", propertyType: "shopping", price: 26000, rent: [5200, 13500, 31000], buildCost: [13000, 26000] },
                // é«˜ãƒ©ãƒ³ã‚¯ (å•†æ¥­æ–½è¨­)
                { id: 22, name: "ä¸Šé‡", type: "property", propertyType: "commercial", price: 45000, rent: [9000, 25000, 60000], buildCost: [30000, 45000] },
                { id: 23, name: "ç§‹è‘‰åŸ", type: "property", propertyType: "commercial", price: 45000, rent: [9000, 25000, 60000], buildCost: [30000, 45000] }
            ];
            
            // ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰
            const EVENT_CARDS = [
                // è‰¯ã„ã‚¤ãƒ™ãƒ³ãƒˆ
                { type: 'good', name: "å»ºè¨­ãƒ–ãƒ¼ãƒ ", description: "ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨å“¡ã‹ã‚‰ 5,000å†† ãšã¤å¾´åã™ã‚‹ã€‚", action: (player) => collectFromOthers(player, 5000) },
                { type: 'good', name: "è³‡ç”£é‹ç”¨æˆåŠŸ", description: "éŠ€è¡Œã‹ã‚‰ 20,000å†† ã‚‚ã‚‰ã†ã€‚", action: (player) => updateMoney(player, 20000) },
                { type: 'good', name: "ãƒ©ãƒƒã‚­ãƒ¼ãƒœãƒ¼ãƒŠã‚¹", description: "ã‚µã‚¤ã‚³ãƒ­ã‚’ã‚‚ã†1å›æŒ¯ã‚‹ã€‚", action: (player) => extraTurn(player) },
                { type: 'good', name: "ã‚¹ã‚¿ãƒ¼ãƒˆãƒã‚¹ã¸ãƒ¯ãƒ¼ãƒ—", description: "ã‚¹ã‚¿ãƒ¼ãƒˆãƒã‚¹ã¸ç§»å‹•ã—ã€çµ¦æ–™ 20,000å†† ã‚’ã‚‚ã‚‰ã†ã€‚", action: (player) => moveTo(player, 0, true) },
                { type: 'good', name: "ç„¡æ–™å¢—ç¯‰", description: "è‡ªåˆ†ãŒæ‰€æœ‰ã™ã‚‹ãƒ“ãƒ«ï¼ˆä¸€ç•ªå®‰ã„ã‚‚ã®ï¼‰ã‚’1æ®µéšã€ç„¡æ–™ã§å¢—ç¯‰ã™ã‚‹ã€‚", action: (player) => freeUpgrade(player) },
                // æ‚ªã„ã‚¤ãƒ™ãƒ³ãƒˆ
                { type: 'bad', name: "ãƒ“ãƒ«ç«ç½", description: "è‡ªåˆ†ãŒæ‰€æœ‰ã™ã‚‹ãƒ“ãƒ«ï¼ˆä¸€ç•ªé«˜ã„ã‚‚ã®ï¼‰ãŒ1æ®µéšãƒ©ãƒ³ã‚¯ãƒ€ã‚¦ãƒ³ã™ã‚‹ã€‚", action: (player) => downgradeBuilding(player) },
                { type: 'bad', name: "ç¨å‹™èª¿æŸ»", description: "è¿½å¾´èª²ç¨ã¨ã—ã¦ 15,000å†† æ”¯æ‰•ã†ã€‚", action: (player) => updateMoney(player, -15000) },
                { type: 'bad', name: "å°é¢¨è¢«å®³", description: "ä¿®ç¹•è²»ã¨ã—ã¦ 10,000å†† æ”¯æ‰•ã†ã€‚", action: (player) => updateMoney(player, -10000) },
                { type: 'bad', name: "æ™¯æ°—å¾Œé€€", description: "æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã€1å›ä¼‘ã¿ã€‚", action: (player) => skipTurn(player) },
                { type: 'bad', name: "CPUã®ãƒã‚¹ã¸ãƒ¯ãƒ¼ãƒ—", description: "ä¸€ç•ªé ãã«ã‚ã‚‹CPUæ‰€æœ‰ã®ãƒ“ãƒ«ãƒã‚¹ã¸å¼·åˆ¶ç§»å‹•ã—ã€é€šè¡Œæ–™ã‚’æ”¯æ‰•ã†ã€‚", action: (player) => moveToEnemyProperty(player) }
            ];

            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ (State)
            let gameState = {};
            let confettiInterval = null;

            // --- 3. ã‚²ãƒ¼ãƒ åˆæœŸåŒ– ---

            function initializeGame() {
                // ãƒœãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–
                const initialBoardState = BOARD_DEFINITION.map(cell => {
                    const state = { ...cell }; // å®šç¾©ã‚’ã‚³ãƒ”ãƒ¼
                    if (state.type === 'property') {
                        state.owner = null; // 'player', 'cpu1', 'cpu2'
                        state.level = 0; // 0:æœªè³¼å…¥, 1:åˆæœŸãƒ“ãƒ«, 2:ä¸­ãƒ“ãƒ«, 3:å¤§ãƒ“ãƒ«
                    }
                    return state;
                });

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–
                const initialPlayers = [
                    { id: 'player', name: 'ã‚ãªãŸ', money: 100000, position: 0, isBankrupt: false, skipNextTurn: false },
                    { id: 'cpu1', name: 'CPU 1', money: 100000, position: 0, isBankrupt: false, skipNextTurn: false },
                    { id: 'cpu2', name: 'CPU 2', money: 100000, position: 0, isBankrupt: false, skipNextTurn: false }
                ];

                gameState = {
                    board: initialBoardState,
                    players: initialPlayers,
                    currentPlayerIndex: 0,
                    gameInProgress: true,
                    hasExtraTurn: false,
                };

                updateBoardUI();
                updateAllPlayersUI();
                updateAllPiecesPosition();
                logMessage("ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚");
                rollDiceBtn.disabled = false;
                stopConfetti(); 
            }
            
            // --- 4. UIæ›´æ–°é–¢æ•° ---
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚°ã®è¿½åŠ 
            function logMessage(message) {
                const p = document.createElement('p');
                p.textContent = message;
                messageLog.appendChild(p);
                // å¸¸ã«ä¸€ç•ªä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                messageLog.scrollTop = messageLog.scrollHeight;
            }

            // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹UIã‚’æ›´æ–°
            function updateAllPlayersUI() {
                if (!gameState.players) return; // åˆæœŸåŒ–å‰
                gameState.players.forEach(player => {
                    moneyElements[player.id].textContent = `Â¥${player.money.toLocaleString()}`;
                    if (player.isBankrupt && !statusElements[player.id].classList.contains('bankrupt')) {
                        statusElements[player.id].classList.add('bankrupt');
                        pieceElements[player.id].classList.add('hidden');
                    } else if (!player.isBankrupt) {
                        statusElements[player.id].classList.remove('bankrupt');
                        pieceElements[player.id].classList.remove('hidden');
                    }
                });
            }
            
            // â˜…å¤‰æ›´ï¼šãƒœãƒ¼ãƒ‰ã®ãƒã‚¹ç›®UIã‚’æ›´æ–° (ãƒ†ã‚­ã‚¹ãƒˆãƒ©ãƒƒãƒ—ã€é‡ãªã‚Šé˜²æ­¢å¯¾å¿œ)
            function updateBoardUI() {
                if (!gameState.board) return; // åˆæœŸåŒ–å‰
                gameState.board.forEach(cell => {
                    const cellEl = document.getElementById(`cell-${cell.id}`);
                    if (!cellEl) return;
                    
                    if (cell.type === 'property') {
                        // ã‚ªãƒ¼ãƒŠãƒ¼ãƒãƒƒã‚¸ã¨ãƒ“ãƒ«ãƒ¬ãƒ™ãƒ«ä»¥å¤–ã®ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚’å‰Šé™¤
                        const textNodes = Array.from(cellEl.childNodes).filter(node => 
                            !node.classList || (!node.classList.contains('owner-badge') && !node.classList.contains('building-level'))
                        );
                        textNodes.forEach(node => cellEl.removeChild(node));

                        // 1. ã‚ªãƒ¼ãƒŠãƒ¼è¡¨ç¤º (Get or Create)
                        let ownerBadge = cellEl.querySelector('.owner-badge');
                        if (!ownerBadge) {
                            ownerBadge = document.createElement('div');
                            ownerBadge.className = 'owner-badge';
                            cellEl.appendChild(ownerBadge);
                        }
                        
                        if (cell.owner === 'player') ownerBadge.style.backgroundColor = '#3b82f6'; // blue-500
                        else if (cell.owner === 'cpu1') ownerBadge.style.backgroundColor = '#ef4444'; // red-500
                        else if (cell.owner === 'cpu2') ownerBadge.style.backgroundColor = '#22c55e'; // green-500
                        else ownerBadge.style.backgroundColor = 'transparent';

                        // 2. ãƒã‚¹æƒ…å ± (ãƒ†ã‚­ã‚¹ãƒˆãƒ©ãƒƒãƒ‘ãƒ¼)
                        const textWrapper = document.createElement('div');
                        
                        let propertyTypeText = '';
                        if (cell.propertyType === 'building') propertyTypeText = '[ãƒ“ãƒ«]';
                        else if (cell.propertyType === 'commercial') propertyTypeText = '[å•†æ¥­]';
                        else if (cell.propertyType === 'shopping') propertyTypeText = '[å•†åº—]';
                        
                        textWrapper.innerHTML += `<span class="block text-center">${cell.name}</span>`;
                        textWrapper.innerHTML += `<span class="block text-center text-xs">${propertyTypeText}</span>`;

                        const priceText = cell.level === 0 ? `Â¥${(cell.price / 1000).toFixed(0)}k` : `R:Â¥${(cell.rent[cell.level - 1] / 1000).toFixed(0)}k`;
                        textWrapper.innerHTML += `<span class="block text-center font-bold">${priceText}</span>`;
                        
                        cellEl.appendChild(textWrapper); // ãƒ†ã‚­ã‚¹ãƒˆãƒ©ãƒƒãƒ‘ãƒ¼ã‚’è¿½åŠ 

                        // 3. ãƒ“ãƒ«ãƒ¬ãƒ™ãƒ« (Get or Create)
                        let levelDiv = cellEl.querySelector('.building-level');
                        if (!levelDiv) {
                            levelDiv = document.createElement('div');
                            levelDiv.className = 'building-level';
                            cellEl.appendChild(levelDiv); // ä¸€åº¦ã ã‘è¿½åŠ 
                        }
                        levelDiv.innerHTML = ''; // ä¸­èº«ã‚’ãƒªã‚»ãƒƒãƒˆ
                        
                        for (let i = 0; i < cell.level; i++) {
                            const block = document.createElement('span');
                            if (cell.propertyType === 'building') block.className = 'built-building';
                            else if (cell.propertyType === 'commercial') block.className = 'built-commercial';
                            else if (cell.propertyType === 'shopping') block.className = 'built-shopping';
                            levelDiv.appendChild(block);
                        }
                    }
                });
            }

            // å…¨ã¦ã®é§’ã®ä½ç½®ã‚’æ›´æ–°
            function updateAllPiecesPosition() {
                if (gameState.players && gameState.players.length > 0) {
                    gameState.players.forEach(player => {
                        movePiece(player.id, player.position);
                    });
                } else {
                    // gameStateãŒåˆæœŸåŒ–ã•ã‚Œã‚‹å‰
                    movePiece('player', 0);
                    movePiece('cpu1', 0);
                    movePiece('cpu2', 0);
                }
            }

            // ç‰¹å®šã®é§’ã‚’æŒ‡å®šã®ãƒã‚¹ã«ç§»å‹•
            function movePiece(playerId, cellId) {
                const piece = pieceElements[playerId];
                const cell = document.getElementById(`cell-${cellId}`);
                if (!piece || !cell) return;
                
                const boardEl = document.getElementById('board');
                const boardRect = boardEl.getBoundingClientRect();
                const cellRect = cell.getBoundingClientRect();

                if (!boardRect || !cellRect) {
                    console.error("Board or cell element not found for piece movement.");
                    return;
                }

                const x = cellRect.left - boardRect.left;
                const y = cellRect.top - boardRect.top;
                
                piece.style.left = `${x}px`;
                piece.style.top = `${y}px`;
            }

            // --- 5. ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ (ã‚³ã‚¢) ---

            // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®å‡¦ç†
            startBtn.addEventListener('click', () => {
                titleScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                initializeGame();
            });

            loadBtn.addEventListener('click', () => {
                if (loadGame()) {
                    titleScreen.classList.add('hidden');
                    gameScreen.classList.remove('hidden');
                    logMessage("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
                } else {
                    showModal("ãƒ­ãƒ¼ãƒ‰å¤±æ•—", "ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚", [{ text: "OK", value: true, class: "bg-red-500" }]);
                }
            });

            saveBtn.addEventListener('click', saveGame);

            // ã‚µã‚¤ã‚³ãƒ­ãƒœã‚¿ãƒ³ã®å‡¦ç†
            rollDiceBtn.addEventListener('click', () => {
                const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                if (currentPlayer.id === 'player' && !rollDiceBtn.disabled) {
                    rollDiceBtn.disabled = true; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã‚‚æŠ¼ã›ãªã„ã‚ˆã†ã«
                    playTurn(currentPlayer);
                }
            });

            // â˜…è¿½åŠ ï¼šã‚µã‚¤ã‚³ãƒ­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            async function animateDiceRoll() {
                rollDiceBtn.disabled = true;
                const pips = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'];
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                let cycles = 0;
                await new Promise(resolve => {
                    const rollInterval = setInterval(() => {
                        diceDisplay.textContent = pips[Math.floor(Math.random() * 6)];
                        cycles++;
                        if (cycles > 10) { // ç´„1ç§’
                            clearInterval(rollInterval);
                            resolve();
                        }
                    }, 100);
                });
                
                // æœ€çµ‚çµæœ
                const roll = Math.floor(Math.random() * 6) + 1;
                diceDisplay.textContent = pips[roll - 1];
                
                return roll;
            }

            // ã‚¿ãƒ¼ãƒ³å‡¦ç† (ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—)
            async function playTurn(player) {
                if (player.isBankrupt) {
                    logMessage(`${player.name} ã¯ç ´ç”£ã—ã¦ã„ã‚‹ãŸã‚ã€ã‚¿ãƒ¼ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`);
                    endTurn();
                    return;
                }
                
                if (player.skipNextTurn) {
                    player.skipNextTurn = false;
                    logMessage(`${player.name} ã¯æ™¯æ°—å¾Œé€€ã®å½±éŸ¿ã§1å›ä¼‘ã¿ã§ã™ã€‚`);
                    endTurn();
                    return;
                }

                gameState.hasExtraTurn = false;

                // 1. â˜…å¤‰æ›´ï¼šã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹ (ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³)
                logMessage(`${player.name} ã¯ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ãŸï¼`);
                const roll = await animateDiceRoll();
                logMessage(`${roll} ãŒå‡ºãŸã€‚`);


                // 2. é§’ã‚’ç§»å‹•
                const oldPosition = player.position;
                const newPosition = (oldPosition + roll) % 24; 
                player.position = newPosition;

                await animateMove(player.id, oldPosition, newPosition, roll);

                // 3. ã‚¹ã‚¿ãƒ¼ãƒˆãƒã‚¹é€šéãƒã‚§ãƒƒã‚¯
                if (newPosition < oldPosition) { // å‘¨å›ã—ãŸå ´åˆ
                    logMessage(`${player.name} ã¯ã‚¹ã‚¿ãƒ¼ãƒˆãƒã‚¹ã‚’é€šéï¼ çµ¦æ–™ Â¥20,000 ã‚’ç²å¾—ã€‚`);
                    updateMoney(player, 20000);
                }

                // 4. åœæ­¢ãƒã‚¹ã®å‡¦ç†
                const currentCell = gameState.board[newPosition];
                await handleCellAction(player, currentCell);
                
                // 5. ã‚¿ãƒ¼ãƒ³çµ‚äº†å‡¦ç†
                if (checkGameOver()) return;
                
                if (!gameState.hasExtraTurn) {
                    endTurn();
                } else {
                    // ãƒ©ãƒƒã‚­ãƒ¼ãƒœãƒ¼ãƒŠã‚¹ãªã©ã§è¿½åŠ ã‚¿ãƒ¼ãƒ³
                    logMessage(`${player.name} ã¯ã‚‚ã†ä¸€åº¦ã‚¿ãƒ¼ãƒ³ã‚’è¡Œã„ã¾ã™ï¼`);
                    if (player.id === 'player') {
                        rollDiceBtn.disabled = false;
                    } else {
                        setTimeout(() => playTurn(player), 1000);
                    }
                }
            }
            
            // é§’ã®ç§»å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (ç°¡æ˜“)
            function animateMove(playerId, start, end, steps) {
                return new Promise(resolve => {
                    let current = start;
                    const piece = pieceElements[playerId];
                    
                    const moveInterval = setInterval(() => {
                        current = (current + 1) % 24;
                        movePiece(playerId, current);
                        
                        if (current === end) {
                            clearInterval(moveInterval);
                            resolve();
                        }
                    }, 300); // 1ãƒã‚¹0.3ç§’
                });
            }

            // ã‚¿ãƒ¼ãƒ³çµ‚äº†
            function endTurn() {
                if (!gameState.gameInProgress) return; // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚

                let nextIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
                
                // ç ´ç”£ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã‚¹ã‚­ãƒƒãƒ—
                while (gameState.players[nextIndex].isBankrupt) {
                    nextIndex = (nextIndex + 1) % gameState.players.length;
                }
                
                gameState.currentPlayerIndex = nextIndex;
                const nextPlayer = gameState.players[nextIndex];
                
                logMessage(`--- ${nextPlayer.name} ã®ã‚¿ãƒ¼ãƒ³ ---`);

                if (nextPlayer.id === 'player') {
                    rollDiceBtn.disabled = false;
                } else {
                    rollDiceBtn.disabled = true;
                    // CPUã®ã‚¿ãƒ¼ãƒ³ã‚’è‡ªå‹•å®Ÿè¡Œ
                    setTimeout(() => playTurn(nextPlayer), 1500); // 1.5ç§’å¾…æ©Ÿ
                }
            }
            
            // åœæ­¢ãƒã‚¹ã®å‡¦ç†
            async function handleCellAction(player, cell) {
                logMessage(`${player.name} ã¯ ã€Œ${cell.name}ã€ ã«æ­¢ã¾ã£ãŸã€‚`);
                
                switch(cell.type) {
                    case 'start':
                        logMessage("ã‚¹ã‚¿ãƒ¼ãƒˆãƒã‚¹ã«æ­¢ã¾ã£ãŸã€‚");
                        break;
                    case 'property':
                        await handlePropertyCell(player, cell);
                        break;
                    case 'event':
                        await handleEventCell(player);
                        break;
                }
            }

            // ãƒ“ãƒ«ãƒã‚¹ã®å‡¦ç†
            async function handlePropertyCell(player, cell) {
                // cell ã¯ gameState.board ã®å‚ç…§
                
                if (cell.owner === null) {
                    // 1. ç©ºãç‰©ä»¶
                    if (player.money >= cell.price) {
                        if (player.id === 'player') {
                            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: è³¼å…¥ç¢ºèª
                            const buy = await showModal(
                                "ç‰©ä»¶è³¼å…¥",
                                `${cell.name} (Â¥${cell.price.toLocaleString()}) ã‚’è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ (æ‰€æŒé‡‘: Â¥${player.money.toLocaleString()})`,
                                [{ text: "è³¼å…¥ã™ã‚‹", value: true, class: "bg-blue-500" }, { text: "ã‚„ã‚ã‚‹", value: false, class: "bg-gray-500" }]
                            );
                            if (buy) {
                                buyProperty(player, cell);
                            }
                        } else {
                            // CPU: AIã§è³¼å…¥åˆ¤æ–­
                            if (cpuShouldBuy(player, cell)) {
                                logMessage(`${player.name} ã¯ Â¥${cell.price.toLocaleString()} ã§ ${cell.name} ã‚’è³¼å…¥ã—ãŸã€‚`);
                                buyProperty(player, cell);
                            } else {
                                logMessage(`${player.name} ã¯ ${cell.name} ã®è³¼å…¥ã‚’è¦‹é€ã£ãŸã€‚`);
                            }
                        }
                    } else {
                        logMessage(`${player.name} ã¯æ‰€æŒé‡‘ãŒè¶³ã‚Šãšã€ ${cell.name} ã‚’è³¼å…¥ã§ããªã„ã€‚`);
                    }
                    
                } else if (cell.owner === player.id) {
                    // 2. è‡ªåˆ†ã®ç‰©ä»¶ (å¢—ç¯‰)
                    if (cell.level > 0 && cell.level < cell.rent.length) {
                        const buildCost = cell.buildCost[cell.level - 1];
                        if (player.money >= buildCost) {
                             if (player.id === 'player') {
                                const upgrade = await showModal(
                                    "ç‰©ä»¶å¢—ç¯‰",
                                    `${cell.name} ã‚’å¢—ç¯‰ã—ã¾ã™ã‹ï¼Ÿ (è²»ç”¨: Â¥${buildCost.toLocaleString()}) (ç¾åœ¨Lv${cell.level} â†’ Lv${cell.level + 1})`,
                                    [{ text: "å¢—ç¯‰ã™ã‚‹", value: true, class: "bg-blue-500" }, { text: "ã‚„ã‚ã‚‹", value: false, class: "bg-gray-500" }]
                                );
                                if (upgrade) {
                                    upgradeProperty(player, cell);
                                }
                             } else {
                                // CPU: AIã§å¢—ç¯‰åˆ¤æ–­
                                if (cpuShouldUpgrade(player, cell)) {
                                    logMessage(`${player.name} ã¯ Â¥${buildCost.toLocaleString()} ã§ ${cell.name} ã‚’å¢—ç¯‰ã—ãŸã€‚`);
                                    upgradeProperty(player, cell);
                                }
                             }
                        }
                    } else if (cell.level === cell.rent.length) {
                        logMessage(`${cell.name} ã¯ã™ã§ã«æœ€å¤§ã®ç‰©ä»¶ã§ã™ã€‚`);
                    }

                } else {
                    // 3. ä»–äººã®ç‰©ä»¶ (é€šè¡Œæ–™æ”¯æ‰•ã„)
                    const owner = gameState.players.find(p => p.id === cell.owner);
                    if (owner && !owner.isBankrupt) {
                        const rent = cell.rent[cell.level - 1]; // levelã¯1, 2, 3
                        logMessage(`${player.name} ã¯ ${owner.name} ã«é€šè¡Œæ–™ Â¥${rent.toLocaleString()} ã‚’æ”¯æ‰•ã†ã€‚`);
                        
                        updateMoney(player, -rent);
                        if (gameState.gameInProgress) { // æ”¯æ‰•ã„ã§ç ´ç”£ã—ãªã‹ã£ãŸå ´åˆ
                            updateMoney(owner, rent);
                        }
                    }
                }
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ã®å‡¦ç†
            async function handleEventCell(player) {
                const card = EVENT_CARDS[Math.floor(Math.random() * EVENT_CARDS.length)];
                
                logMessage(`ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼ ã€${card.name}ã€‘`);
                
                if (player.id === 'player') {
                     await showModal(
                        `ã‚¤ãƒ™ãƒ³ãƒˆ: ${card.name}`,
                        card.description,
                        [{ text: "OK", value: true, class: "bg-blue-500" }]
                    );
                } else {
                    // CPUã®å ´åˆã¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å¾…ãŸãšã«å³æ™‚å®Ÿè¡Œ
                    await new Promise(r => setTimeout(r, 1000)); // 1ç§’ã‚¦ã‚§ã‚¤ãƒˆ
                }
                
                // ã‚¤ãƒ™ãƒ³ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
                card.action(player);
            }


            // --- 6. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢æ•° (ãƒ“ãƒ«ãƒ»é‡‘) ---
            
            function buyProperty(player, cell) {
                player.money -= cell.price;
                cell.owner = player.id;
                cell.level = 1; // åˆæœŸãƒ“ãƒ«
                logMessage(`${player.name} ãŒ ${cell.name} ã‚’è³¼å…¥ï¼ (Lv1)`);
                updateBoardUI();
                updateAllPlayersUI();
            }

            function upgradeProperty(player, cell) {
                const cost = cell.buildCost[cell.level - 1];
                player.money -= cost;
                cell.level += 1;
                logMessage(`${player.name} ãŒ ${cell.name} ã‚’å¢—ç¯‰ï¼ (Lv${cell.level})`);
                updateBoardUI();
                updateAllPlayersUI();
            }

            // ãŠé‡‘ã®å¢—æ¸›ã¨ç ´ç”£ãƒã‚§ãƒƒã‚¯
            function updateMoney(player, amount) {
                player.money += amount;
                
                if (amount > 0) {
                    logMessage(`${player.name} ã¯ Â¥${amount.toLocaleString()} ã‚’æ‰‹ã«å…¥ã‚ŒãŸã€‚ (æ‰€æŒé‡‘: Â¥${player.money.toLocaleString()})`);
                } else if (amount < 0) {
                    logMessage(`${player.name} ã¯ Â¥${(-amount).toLocaleString()} ã‚’æ”¯æ‰•ã£ãŸã€‚ (æ‰€æŒé‡‘: Â¥${player.money.toLocaleString()})`);
                }

                if (player.money < 0) {
                    handleBankruptcy(player);
                }
                
                if (gameState.gameInProgress) {
                    updateAllPlayersUI();
                }
            }
            
            // ç ´ç”£å‡¦ç†
            function handleBankruptcy(player) {
                logMessage(`ï¼ï¼ï¼ ${player.name} ã¯ç ´ç”£ã—ãŸ ï¼ï¼ï¼`);
                player.isBankrupt = true;
                player.money = 0;
                
                // ç ´ç”£è€…ã®ç‰©ä»¶ã‚’ã™ã¹ã¦è§£æ”¾
                gameState.board.forEach(cell => {
                    if (cell.owner === player.id) {
                        cell.owner = null;
                        cell.level = 0;
                    }
                });
                
                updateBoardUI();
                updateAllPlayersUI(); // ç ´ç”£è¡¨ç¤ºã‚’åæ˜ 
                checkGameOver();
            }
            
            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒã‚§ãƒƒã‚¯
            function checkGameOver() {
                if (!gameState.players) return false; // åˆæœŸåŒ–å‰
                const activePlayers = gameState.players.filter(p => !p.isBankrupt);
                
                if (activePlayers.length === 1) {
                    const winner = activePlayers[0];
                    logMessage(`ã‚²ãƒ¼ãƒ çµ‚äº†ï¼ ${winner.name} ã®å‹åˆ©ã§ã™ï¼`);
                    
                    gameState.gameInProgress = false;
                    rollDiceBtn.disabled = true;
                    
                    startConfetti(); // å‹åˆ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–‹å§‹

                    showModal(
                        "ã‚²ãƒ¼ãƒ çµ‚äº†ï¼",
                        `${winner.name} ã®å‹åˆ©ã§ã™ï¼`,
                        [{ text: "ã‚¿ã‚¤ãƒˆãƒ«ã¸", value: "title", class: "bg-blue-500" }]
                    ).then(() => {
                        // ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹
                        gameScreen.classList.add('hidden');
                        titleScreen.classList.remove('hidden');
                        stopConfetti(); // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåœæ­¢
                    });
                    
                    return true;
                    
                } else if (gameState.players[0].isBankrupt) {
                    logMessage("ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼... ã‚ãªãŸã¯ç ´ç”£ã—ã¾ã—ãŸã€‚");

                    gameState.gameInProgress = false;
                    rollDiceBtn.disabled = true;

                    showModal(
                        "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼",
                        "ã‚ãªãŸã¯ç ´ç”£ã—ã¾ã—ãŸ...",
                        [{ text: "ã‚¿ã‚¤ãƒˆãƒ«ã¸", value: "title", class: "bg-blue-500" }]
                    ).then(() => {
                        // ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹
                        gameScreen.classList.add('hidden');
                        titleScreen.classList.remove('hidden');
                    });
                    
                    return true;
                }
                return false;
            }


            // --- 7. CPU AIãƒ­ã‚¸ãƒƒã‚¯ ---
            
            function cpuShouldBuy(cpu, cell) {
                // æ‰€æŒé‡‘ãŒ (ä¾¡æ ¼ * 2) ä»¥ä¸Šãªã‚‰è³¼å…¥
                return cpu.money >= (cell.price * 2);
            }
            
            function cpuShouldUpgrade(cpu, cell) {
                const cost = cell.buildCost[cell.level - 1];
                // æ‰€æŒé‡‘ãŒ (å¢—ç¯‰è²» * 3) ä»¥ä¸Šãªã‚‰å¢—ç¯‰
                return cpu.money >= (cost * 3);
            }

            // --- 8. ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
            
            function collectFromOthers(player, amount) {
                gameState.players.forEach(p => {
                    if (p.id !== player.id && !p.isBankrupt) {
                        updateMoney(p, -amount);
                        if (gameState.gameInProgress) { // ç›¸æ‰‹ãŒç ´ç”£ã—ãªã‹ã£ãŸå ´åˆ
                            updateMoney(player, amount);
                        }
                    }
                });
            }
            
            function extraTurn(player) {
                gameState.hasExtraTurn = true;
            }

            function moveTo(player, cellId, getSalary) {
                player.position = cellId;
                movePiece(player.id, cellId); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§å³æ™‚ç§»å‹•
                if (getSalary) {
                    updateMoney(player, 20000);
                }
            }
            
            function freeUpgrade(player) {
                // è‡ªåˆ†ãŒæ‰€æœ‰ã™ã‚‹ä¸€ç•ªå®‰ã„ãƒ“ãƒ«ã‚’æ¢ã™
                let cheapestProperty = null;
                let minLevel = 4; // æœ€å¤§ãƒ¬ãƒ™ãƒ«+1
                
                gameState.board.forEach(cell => {
                    if (cell.owner === player.id && cell.level > 0 && cell.level < cell.rent.length) { // å¢—ç¯‰å¯èƒ½
                        if (cell.level < minLevel) {
                            minLevel = cell.level;
                            cheapestProperty = cell;
                        } else if (cell.level === minLevel) {
                            // åŒã˜ãƒ¬ãƒ™ãƒ«ãªã‚‰ä¾¡æ ¼ãŒå®‰ã„æ–¹
                            if (!cheapestProperty || cell.price < cheapestProperty.price) {
                                cheapestProperty = cell;
                            }
                        }
                    }
                });
                
                if (cheapestProperty) {
                    cheapestProperty.level += 1;
                    logMessage(`${player.name} ã¯ ${cheapestProperty.name} ã‚’ç„¡æ–™ã§å¢—ç¯‰ï¼ (Lv${cheapestProperty.level})`);
                    updateBoardUI();
                } else {
                    logMessage(`${player.name} ã¯å¢—ç¯‰ã§ãã‚‹ç‰©ä»¶ã‚’æŒã£ã¦ã„ãªã‹ã£ãŸã€‚`);
                }
            }

            function downgradeBuilding(player) {
                 // è‡ªåˆ†ãŒæ‰€æœ‰ã™ã‚‹ä¸€ç•ªé«˜ã„ãƒ“ãƒ«ã‚’æ¢ã™
                let priciestProperty = null;
                let maxLevel = 0;
                
                gameState.board.forEach(cell => {
                    if (cell.owner === player.id && cell.level > 0) { // ãƒ“ãƒ«ã‚’æŒã£ã¦ã„ã‚‹
                        if (cell.level > maxLevel) {
                            maxLevel = cell.level;
                            priciestProperty = cell;
                        } else if (cell.level === maxLevel) {
                            if (!priciestProperty || cell.price > priciestProperty.price) {
                                priciestProperty = cell;
                            }
                        }
                    }
                });
                
                if (priciestProperty) {
                    priciestProperty.level -= 1;
                    const status = priciestProperty.level === 0 ? "ç©ºãç‰©ä»¶ã«ãªã£ãŸ" : `Lv${priciestProperty.level} ã«ãƒ©ãƒ³ã‚¯ãƒ€ã‚¦ãƒ³ã—ãŸ`;
                    if(priciestProperty.level === 0) {
                        priciestProperty.owner = null; // ã‚ªãƒ¼ãƒŠãƒ¼ã‚‚å¤±ã†
                    }
                    logMessage(`${player.name} ã® ${priciestProperty.name} ãŒç«äº‹ã«ï¼ ${status}`);
                    updateBoardUI();
                } else {
                    logMessage(`${player.name} ã¯ç‰©ä»¶ã‚’æŒã£ã¦ã„ãªã‹ã£ãŸã€‚`);
                }
            }
            
            function skipTurn(player) {
                player.skipNextTurn = true;
            }

            function moveToEnemyProperty(player) {
                let targetCell = null;
                let maxDistance = -1;
                
                const otherPlayerIds = gameState.players
                    .filter(p => p.id !== player.id && !p.isBankrupt)
                    .map(p => p.id);

                if (otherPlayerIds.length === 0) {
                    logMessage("ç§»å‹•å¯¾è±¡ã®CPUãŒã„ãªã‹ã£ãŸã€‚");
                    return;
                }

                gameState.board.forEach((cell, index) => {
                    if (cell.type === 'property' && otherPlayerIds.includes(cell.owner)) {
                        let distance = (index - player.position + 24) % 24; // é †æ–¹å‘ã®è·é›¢
                        if (distance > maxDistance) {
                            maxDistance = distance;
                            targetCell = cell;
                        }
                    }
                });
                
                if (targetCell) {
                    logMessage(`${player.name} ã¯ ${targetCell.name} ã¸å¼·åˆ¶ç§»å‹•ï¼`);
                    player.position = targetCell.id;
                    movePiece(player.id, targetCell.id);
                    // ãƒã‚¹ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å†å®Ÿè¡Œ (é€šè¡Œæ–™æ”¯æ‰•ã„)
                    handlePropertyCell(player, targetCell);
                } else {
                    logMessage("ç§»å‹•å¯¾è±¡ã®CPUã®ç‰©ä»¶ãŒãªã‹ã£ãŸã€‚");
                }
            }

            // --- 9. ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒ€ã‚¤ã‚¢ãƒ­ã‚°) ---
            
            function showModal(title, message, buttons) {
                return new Promise(resolve => {
                    modalTitle.textContent = title;
                    modalMessage.textContent = message;
                    modalActions.innerHTML = ''; // ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢
                    
                    buttons.forEach(btnInfo => {
                        const button = document.createElement('button');
                        button.textContent = btnInfo.text;
                        button.className = `py-2 px-4 rounded-lg text-white font-bold ${btnInfo.class || 'bg-blue-500'}`;
                        button.onclick = () => {
                            modal.classList.add('hidden');
                            resolve(btnInfo.value); // ãƒœã‚¿ãƒ³ã«è¨­å®šã•ã‚ŒãŸå€¤ã‚’è¿”ã™
                        };
                        modalActions.appendChild(button);
                    });
                    
                    modal.classList.remove('hidden');
                });
            }

            // --- 10. ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ (localStorage) ---
            const SAVE_KEY = 'biru-oh_savedata';

            function saveGame() {
                try {
                    localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
                    logMessage("ã‚²ãƒ¼ãƒ ã‚’ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸã€‚");
                    showModal("ã‚»ãƒ¼ãƒ–å®Œäº†", "ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸã€‚", [{ text: "OK", value: true, class: "bg-blue-500" }]);
                } catch (e) {
                    console.error("Save failed: ", e);
                    showModal("ã‚»ãƒ¼ãƒ–å¤±æ•—", "ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", [{ text: "OK", value: true, class: "bg-red-500" }]);
                }
            }

            function loadGame() {
                const savedData = localStorage.getItem(SAVE_KEY);
                if (savedData) {
                    try {
                        gameState = JSON.parse(savedData);
                        // UIå…¨ä½“ã‚’å¾©å…ƒ
                        updateBoardUI();
                        updateAllPlayersUI();
                        updateAllPiecesPosition();
                        
                        // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’åˆ¶å¾¡
                        const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                        rollDiceBtn.disabled = !gameState.gameInProgress || (currentPlayer.id !== 'player');
                        
                        return true;
                    } catch (e) {
                        console.error("Load failed: ", e);
                        return false;
                    }
                }
                return false;
            }

            // --- 11. å‹åˆ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ---
            
            function startConfetti() {
                stopConfetti(); // æ—¢å­˜ã®ãŒã‚ã‚Œã°æ­¢ã‚ã‚‹
                const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
                confettiInterval = setInterval(() => {
                    if (confettiWrapper.childElementCount > 100) return; // å¢—ãˆã™ãé˜²æ­¢

                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = `${Math.random() * 100}vw`;
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.width = `${Math.random() * 10 + 5}px`;
                    confetti.style.height = `${Math.random() * 10 + 5}px`;
                    confetti.style.animationDuration = `${Math.random() * 2 + 3}s`; // 3ã€œ5ç§’
                    confetti.style.opacity = `${Math.random() * 0.5 + 0.5}`; // 0.5ã€œ1.0

                    // ç”»é¢ç«¯ã«è¡Œã£ãŸã‚‰æ¶ˆã™
                    confetti.addEventListener('animationend', () => {
                        confetti.remove();
                    });
                    
                    confettiWrapper.appendChild(confetti);
                }, 100); // 0.1ç§’ã”ã¨ã«ç”Ÿæˆ
            }
            
            function stopConfetti() {
                if (confettiInterval) {
                    clearInterval(confettiInterval);
                }
                confettiWrapper.innerHTML = ''; // æ®‹éª¸ã‚’ã™ã¹ã¦æ¶ˆã™
            }


            // --- èµ·å‹•æ™‚ ---
            updateAllPiecesPosition();

        });
    </script>
</body>
</html>